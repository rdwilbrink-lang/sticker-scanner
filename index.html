<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barcode Expert Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; }
        header { background: #e62222; color: white; width: 100%; padding: 20px; text-align: center; font-weight: bold; }
        #scanner-container { width: 100%; max-width: 500px; height: 300px; background: #000; position: relative; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-line { position: absolute; top: 50%; left: 10%; width: 80%; height: 2px; background: red; box-shadow: 0 0 8px red; animation: move 2s infinite; }
        @keyframes move { 0%, 100% { top: 30%; } 50% { top: 70%; } }
        .info-box { width: 90%; background: white; margin-top: -20px; padding: 15px; border-radius: 10px; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #eee; }
        .btn { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 10px; color: white; }
    </style>
</head>
<body>

<header>BARCODE POWER SCANNER</header>

<div id="scanner-container">
    <div class="scan-line"></div>
</div>

<div class="info-box" id="last-result">
    Focus op de barcode...
</div>

<div class="table-container">
    <table id="resultTable">
        <thead>
            <tr>
                <th>Gescande Code</th>
                <th>Vermoedelijke Prijs</th>
                <th>Tijd</th>
                <th>Barcode</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div style="display:flex;">
    <button class="btn" style="background:#007bff;" onclick="downloadCSV()">DOWNLOAD EXCEL</button>
    <button class="btn" style="background:#dc3545;" onclick="clearData()">WIS ALLES</button>
</div>

<script>
    let isScanning = false;
    let savedScans = JSON.parse(localStorage.getItem('barcode_scans')) || [];

    window.onload = () => {
        renderTable();
        startScanner();
    };

    function startScanner() {
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#scanner-container'),
                constraints: { facingMode: "environment", focusMode: "continuous" }
            },
            decoder: { readers: ["code_128_reader", "ean_reader"] }, // Pakt zowel prijsstickers als normale barcodes
            locate: true
        }, (err) => {
            if (err) return;
            Quagga.start();
        });

        Quagga.onDetected(handleDetection);
    }

    function handleDetection(data) {
        if (isScanning) return;
        const code = data.codeResult.code;

        // Alleen actie ondernemen als we een sterke scan hebben
        if (code) {
            isScanning = true;
            
            // PRIJS-LOGICA: Veel winkels zetten de prijs in de code
            // We kijken of de laatste 4 of 5 cijfers op een prijs lijken (bijv. 00500 voor 5 euro)
            let prijsVermoeden = "Check sticker";
            if (code.length >= 5) {
                const laatsteDeel = code.slice(-4); 
                const euro = parseInt(laatsteDeel.slice(0, 2));
                const cent = laatsteDeel.slice(2);
                if (!isNaN(euro)) prijsVermoeden = "â‚¬ " + euro + "," + cent;
            }

            const newEntry = {
                id: Date.now(),
                code: code,
                prijs: prijsVermoeden,
                tijd: new Date().toLocaleTimeString()
            };

            savedScans.unshift(newEntry);
            localStorage.setItem('barcode_scans', JSON.stringify(savedScans));
            renderTable();
            
            document.getElementById('last-result').innerHTML = `<b>GEVONDEN:</b> ${code}<br><span style="color:green">${prijsVermoeden}</span>`;
            
            // Even wachten voor de volgende scan zodat hij niet 10x dezelfde pakt
            setTimeout(() => { isScanning = false; }, 3000);
        }
    }

    function renderTable() {
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = "";
        savedScans.forEach(s => {
            const row = tbody.insertRow();
            row.innerHTML = `<td>${s.code}</td><td>${s.prijs}</td><td>${s.tijd}</td><td><svg id="bc-${s.id}"></svg></td>`;
            JsBarcode("#bc-" + s.id, s.code, { format: "CODE128", width: 1.2, height: 40, displayValue: false });
        });
    }

    function clearData() { if(confirm("Lijst wissen?")) { savedScans=[]; localStorage.removeItem('barcode_scans'); renderTable(); } }
    
    function downloadCSV() {
        let csv = "Barcode,Prijs,Tijd\n";
        savedScans.forEach(s => { csv += `"${s.code}","${s.prijs}","${s.tijd}"\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(blob); a.download = 'barcodes.csv'; a.click();
    }
</script>
</body>
</html>
